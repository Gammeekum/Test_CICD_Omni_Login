name: Run DevAssure Tests (Windows)

on:
  push:
    branches:
      - '*'
    tags:
      - '*'
  pull_request:
    branches:
      - '*'
  workflow_dispatch:

env:
  SOURCE_PATH: './Test_CICD'
  TARGET_PATH: 'temp\\'
  SUITE_PATH: './Demo/test-suite/base.suite.tspp'
  DEVASSURE_CLI_URL: 'https://devassures3bucket.s3.amazonaws.com/windows/cli/DevAssure.zip'  # Windows build assumed
  DEVASSURE_TOKEN: ${{ secrets.DEVASSURE_TOKEN }}
  JOB_NAME: 'dev_tests'
  RUN_PROFILE_PATH: './Demo/run-profile/base.profile.tspp'

jobs:
  execute_test:
    runs-on: windows-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Step 3: Install npm and pnpm
      - name: Install npm and pnpm
        shell: pwsh
        run: |
          Write-Host "Installing npm and pnpm..."
          npm install -g pnpm
          npm --version
          npx --version
          node --version

      # Step 4: Download and unzip DevAssure CLI
      - name: Download and Unzip DevAssure CLI
        shell: pwsh
        run: |
          Write-Host "‚¨áÔ∏è Downloading DevAssure CLI for Windows..."
          Invoke-WebRequest -Uri $env:DEVASSURE_CLI_URL -OutFile DevAssure.zip
          Expand-Archive -Path DevAssure.zip -DestinationPath .\DevAssure -Force
          Write-Host "‚úÖ DevAssure CLI extracted."

      # Step 5: Install project dependencies
      - name: Install project dependencies
        working-directory: ${{ env.SOURCE_PATH }}
        shell: pwsh
        run: |
          pnpm install

      # Step 6: Execute DevAssure Tests
      - name: Execute DevAssure Tests
        shell: pwsh
        run: |
          Write-Host "üöÄ Running DevAssure Tests..."
          $cli = ".\DevAssure\DA.exe"
          if (!(Test-Path $cli)) {
              Write-Error "‚ùå DevAssure CLI not found at $cli"
              exit 1
          }

          # Ensure target directory exists
          if (!(Test-Path $env:TARGET_PATH)) {
              New-Item -ItemType Directory -Path $env:TARGET_PATH | Out-Null
          }

          & $cli --auth-token $env:DEVASSURE_TOKEN `
                 --source $env:SOURCE_PATH `
                 --target $env:TARGET_PATH `
                 run --suite $env:SUITE_PATH `
                 --total-nodes 1 --node-id 0 `
                 --branch "${{ github.ref_name }}" `
                 --job-name $env:JOB_NAME `
                 --run-profile $env:RUN_PROFILE_PATH

      # Step 7: Upload Test Results
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: DevAssure_Test_Results_Windows
          path: ${{ env.TARGET_PATH }}

      # Step 8: Send Test Report Email (optional)
      - name: Send Test Report Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: DevAssure Test Results - ${{ github.repository }} (Windows)
          to: gamtaa@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            Hello Gammachuu,

            The DevAssure CI/CD automation workflow for **${{ github.repository }}** has completed successfully on Windows.

            Test results are attached.

            Regards,
            GitHub Actions - DevAssure CI/CD
          attachments: ${{ env.TARGET_PATH }}
