name: DevAssure CI/CD Automation (Windows)

on:
  push:
    branches:
      - main
  workflow_dispatch:   # Allow manual trigger from GitHub UI

jobs:
  devassure-tests:
    runs-on: windows-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Verify DevAssure CLI path
      - name: Locate DevAssure CLI
        shell: pwsh
        run: |
          Write-Host "Checking for DevAssure CLI..."
          $path = "C:\Program Files\DevAssure\cli\devassure-cli.exe"
          if (Test-Path $path) {
              Write-Host "‚úÖ DevAssure CLI found at $path"
          } else {
              Write-Error "‚ùå DevAssure CLI not found at $path. Please ensure it is installed and added to PATH."
          }

      # Step 3: Run DevAssure Automation Tests
      - name: Run DevAssure Tests
        shell: pwsh
        env:
          DEVASSURE_AUTH_TOKEN: ${{ secrets.DEVASSURE_AUTH_TOKEN }}
        run: |
          Write-Host "üöÄ Running DevAssure tests..."
          $cli = "C:\Program Files\DevAssure\cli\devassure-cli.exe"
          if (!(Test-Path $cli)) { 
              Write-Error "DevAssure CLI not found at $cli"
              exit 1
          }

          # Create results directory if not exists
          if (!(Test-Path ".\results")) {
              New-Item -ItemType Directory -Path ".\results" | Out-Null
          }

          # Run DevAssure tests
          & "$cli" run `
              --project .\tests `
              --auth-token $env:DEVASSURE_AUTH_TOKEN `
              --report .\results\results.xml

          Write-Host "‚úÖ DevAssure tests completed successfully."

      # Step 4: Upload test results as artifact
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: DevAssure_Test_Results_Windows
          path: .\results

      # Step 5: Send Test Report Email
      - name: Send Test Report Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: DevAssure Test Results - ${{ github.repository }} (Windows)
          to: gamtaa@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            Hello Gammachuu,

            The DevAssure automation workflow for repo **${{ github.repository }}** has completed successfully on **Windows**.

            Test results are attached.

            Regards,
            GitHub Actions - DevAssure CI/CD
          attachments: .\results\results.xml
