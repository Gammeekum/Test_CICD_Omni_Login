name: DevAssure CI/CD Automation

on:
  push:
    branches:
      - main
  workflow_dispatch:   # Allow manual trigger

jobs:
  devassure-tests:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Set up CLI (Windows & Linux)
      - name: Set up DevAssure CLI
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            # Linux installation (replace with actual CLI download link)
            curl -sSL https://your-devassure-cli-download-url-linux | bash
          else
            # Windows path assumed
            echo "DevAssure CLI should be installed in C:\Program Files\DevAssure\cli\devassure-cli.exe"
          fi

      # Step 3: Run DevAssure tests
      - name: Run DevAssure CLI Tests
        env:
          DEVASSURE_AUTH_TOKEN: ${{ secrets.DEVASSURE_AUTH_TOKEN }}
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            ./devassure-cli run --project ./tests --auth-token $DEVASSURE_AUTH_TOKEN --report ./results/results.xml
          else
            "C:\Program Files\DevAssure\cli\devassure-cli.exe" run --project .\tests --auth-token $ENV:DEVASSURE_AUTH_TOKEN --report .\results\results.xml
          fi

      # Step 4: Upload test results as artifacts
      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        with:
          name: devassure-results
          path: ./results

      # Step 5: Send email with results
      - name: Send Test Report Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}       # Gmail or your SMTP user
          password: ${{ secrets.EMAIL_PASSWORD }}       # App password for Gmail
          subject: DevAssure Test Results - ${{ github.repository }}
          to: your-email@example.com                    # Replace with recipient
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            Hello,

            The DevAssure automation workflow for repo ${{ github.repository }} has completed.

            Test results are attached.

          attachments: ./results/results.xml

