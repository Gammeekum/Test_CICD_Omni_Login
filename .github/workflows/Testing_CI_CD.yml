name: DevAssure CI/CD Automation

on:
  push:
    branches:
      - main
  workflow_dispatch:   # Allow manual trigger

jobs:
  devassure-tests:
    strategy:
      matrix:
        os: [windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Set up DevAssure CLI
      - name: Set up DevAssure CLI
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            echo "Installing DevAssure CLI for Linux..."
            # Replace with your actual CLI installation URL or command
            curl -sSL https://your-devassure-cli-download-url-linux | bash
          else
            echo "Using pre-installed DevAssure CLI on Windows..."
            # Adjust if CLI is in a different path
            dir "C:\Program Files\DevAssure\cli"
          fi

      # Step 3: Run DevAssure Tests
      - name: Run DevAssure CLI Tests
        env:
          DEVASSURE_AUTH_TOKEN: ${{ secrets.DEVASSURE_AUTH_TOKEN }}
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            ./devassure-cli run --project ./tests --auth-token $DEVASSURE_AUTH_TOKEN --report ./results/results.xml
          else
            "C:\Program Files\DevAssure\cli\devassure-cli.exe" run --project .\tests --auth-token $ENV:DEVASSURE_AUTH_TOKEN --report .\results\results.xml
          fi

      # Step 4: Upload test results as artifacts (v4 FIX)
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: DevAssure_Test_Results_${{ matrix.os }}
          path: ./results

      # Step 5: Send Test Report Email
      - name: Send Test Report Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: DevAssure Test Results - ${{ github.repository }} (${{ matrix.os }})
          to: gamtaa@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            Hello,

            The DevAssure automation workflow for repo ${{ github.repository }} has completed on ${{ matrix.os }}.

            Test results are attached.

          attachments: ./results/results.xml
