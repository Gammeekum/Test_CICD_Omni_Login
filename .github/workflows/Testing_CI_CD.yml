name: Run DevAssure Tests (Windows)

on:
  push:
    branches:
      - '*'
    tags:
      - '*'
  pull_request:
    branches:
      - '*'
  workflow_dispatch:

jobs:
  execute_test:
    runs-on: windows-latest
    env:
      JOB_NAME: dev_tests
      DEVASSURE_CLI_URL: https://devassures3bucket.s3.amazonaws.com/linux/cli/DevAssure.zip
      SOURCE_PATH: ./Test_CICD
      TARGET_PATH: ./temp
      SUITE_PATH: ./Test_CICD/test-suite/base.suite.tspp
      RUN_PROFILE_PATH: ./Test_CICD/Test_CICD/run-profile/base.profile.tspp

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Step 3: Install npm and pnpm
      - name: Install npm and pnpm
        shell: pwsh
        run: |
          Write-Host "Installing npm and pnpm..."
          npm install -g pnpm
          npm --version
          npx --version
          node --version
      # Step 4: Download and unzip DevAssure CLI
      - name: Download and Unzip DevAssure CLI
        shell: pwsh
        run: |
          Write-Host "‚¨áÔ∏è Downloading DevAssure CLI for Windows..."
          Invoke-WebRequest -Uri $env:DEVASSURE_CLI_URL -OutFile DevAssure.zip
          Expand-Archive -Path DevAssure.zip -DestinationPath .\DevAssure -Force
          Write-Host "‚úÖ DevAssure CLI extracted."
      # Step 5: Validate Suite and Profile Files
      - name: Validate Test Suite and Run Profile
        shell: pwsh
        run: |
         Write-Host "üîç Validating test suite and run profile paths..."
          if (!(Test-Path $env:SUITE_PATH)) {
          Write-Error "‚ùå Test suite file not found at $env:SUITE_PATH"
          exit 1
         }
         if (!(Test-Path $env:RUN_PROFILE_PATH)) {
          Write-Error "‚ùå Run profile file not found at $env:RUN_PROFILE_PATH"
         exit 1
         }
          Write-Host "‚úÖ Paths are valid."
      # Step 6: Prepare target directory
      - name: Prepare Target Directory
        shell: pwsh
        run: |
          if (!(Test-Path $env:TARGET_PATH)) {
              New-Item -ItemType Directory -Path $env:TARGET_PATH -Force | Out-Null
          }
      # Step 7: Execute DevAssure Tests
            # Step 7: Execute DevAssure Tests
      - name: Execute DevAssure Tests
        shell: pwsh
        env:
          DEVASSURE_AUTH_TOKEN: ${{ secrets.DEVASSURE_AUTH_TOKEN }}
        run: |
          Write-Host "üöÄ Running DevAssure Tests..."
          $cli = "./DevAssure/DA"
          chmod +x $cli
          if (!(Test-Path $cli)) {
              Write-Error "‚ùå DevAssure CLI not found at $cli"
              exit 1
          }

    # Ensure target directory exists and is clean
    if (Test-Path $env:TARGET_PATH) {
        Write-Host "üßπ Clearing old results in $env:TARGET_PATH..."
        Remove-Item "$env:TARGET_PATH\*" -Recurse -Force -ErrorAction SilentlyContinue
    } else {
        New-Item -ItemType Directory -Path $env:TARGET_PATH | Out-Null
    }

    if (-not $env:DEVASSURE_AUTH_TOKEN) {
        Write-Error "‚ùå DEVASSURE_AUTH_TOKEN is empty! Check GitHub Secrets."
        exit 1
    }

    # ‚úÖ Run tests
    & $cli --auth-token "$env:DEVASSURE_AUTH_TOKEN" `
           --source $env:SOURCE_PATH `
           --target $env:TARGET_PATH `
           run --suite $env:SUITE_PATH `
           --total-nodes 1 --node-id 0 `
           --branch "${{ github.ref_name }}" `
           --job-name $env:JOB_NAME `
           --run-profile $env:RUN_PROFILE_PATH

    # ‚úÖ Explicitly generate HTML report in the target folder
    if (Test-Path "$env:TARGET_PATH") {
        Write-Host "üßæ Generating HTML report manually..."
        & $cli report --target $env:TARGET_PATH
    } else {
        Write-Warning "‚ö†Ô∏è Test result folder not found ‚Äî skipping report generation."
    }

      # Step 8: Upload Test Results
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: DevAssure_Test_Results_Windows
          path: ${{ env.TARGET_PATH }}

      # Step 9: Send Test Report Email (optional)
      - name: Send Test Report Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: DevAssure Test Results - ${{ github.repository }} (Windows)
          to: gamtaa@gmail.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            Hello Gammachuu,
            The DevAssure CI/CD automation workflow for **${{ github.repository }}** has completed successfully on Windows.
            Test results are attached.
            Regards,
            GitHub Actions - DevAssure CI/CD
          attachments: ${{ env.TARGET_PATH }}
