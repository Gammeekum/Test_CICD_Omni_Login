name: Run DevAssure Tests

on:
  push:
    branches:
      - '*'
    tags:
      - '*'
  pull_request:
    branches:
      - '*'
  workflow_dispatch:

env:
  SOURCE_PATH: './Demo'
  TARGET_PATH: 'temp/'
  SUITE_PATH: './Demo/test-suite/base.suite.tspp'
  DEVASSURE_CLI_URL: 'https://devassures3bucket.s3.amazonaws.com/linux/cli/DevAssure.zip'
  DEVASSURE_TOKEN: ${{ secrets.DEVASSURE_TOKEN }}
  JOB_NAME: 'dev_tests'
  RUN_PROFILE_PATH: './Demo/run-profile/base.profile.tspp'

jobs:

  execute_test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install npm
        run: |
          echo "Installing npm..."
          npm install -g pnpm
          npm --version
          npx --version
          node --version

      - name: Install DevAssure CLI dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libasound2 libatk-bridge2.0-0 libatk1.0-0 libatspi2.0-0 libcairo2 libcups2 libdbus-1-3 libdrm2 libgbm1 libglib2.0-0 libnspr4 libnss3 libpango-1.0-0 libwayland-client0 libx11-6 libxcb1 libxcomposite1 libxdamage1 libxext6 libxfixes3 libxkbcommon0 libxrandr2 ffmpeg libcairo-gobject2 libdbus-glib-1-2 libfontconfig1 libfreetype6 libgdk-pixbuf-2.0-0 libgtk-3-0 libpangocairo-1.0-0 libx11-xcb1 libxcb-shm0 libxcursor1 libxi6 libxrender1 libxtst6 libsoup-3.0-0 libenchant-2-2 gstreamer1.0-libav gstreamer1.0-plugins-bad gstreamer1.0-plugins-base gstreamer1.0-plugins-good libicu70 libegl1 libepoxy0 libevdev2 libffi7 libgles2 libglx0 libgstreamer-gl1.0-0 libgstreamer-plugins-base1.0-0 libgstreamer1.0-0 libgtk-4-1 libgudev-1.0-0 libharfbuzz-icu0 libharfbuzz0b libhyphen0 libjpeg-turbo8 liblcms2-2 libmanette-0.2-0 libnotify4 libopengl0 libopenjp2-7 libopus0 libpng16-16 libproxy1v5 libsecret-1-0 libwayland-egl1 libwayland-server0 libwebpdemux2 libwoff1 libxml2 libxslt1.1 libx264-163 libatomic1 libevent-2.1-7 libavif13 xvfb fonts-noto-color-emoji fonts-unifont xfonts-cyrillic xfonts-scalable fonts-liberation fonts-ipafont-gothic fonts-wqy-zenhei fonts-tlwg-loma-otf fonts-freefont-ttf

      - name: Download and Unzip DevAssure CLI
        run: |
          echo "Download and unzip DevAssure CLI ..."
          curl -L $DEVASSURE_CLI_URL -o DevAssure.zip
          unzip DevAssure.zip
      - name: Install project dependencies
        working-directory: ${{ env.SOURCE_PATH }}
        run: |
          pnpm install 
      - name: Setup DevAssure dependencies (Workaround)
        run: |
          echo "Workaround: Manually setting up DevAssure dependencies..."
          chmod +x ./tpp_setup_browsers || true
          ./tpp_setup_browsers || echo "tpp_setup_browsers failed but continuing..."


      - name: Execute Tests
        run: |
          echo "Execute Tests ..."
          chmod +x ./DA
          mkdir -m 777 /home/runner/work/ui-app/ui-app/temp/
          ls -l
          ./DA --auth-token $DEVASSURE_TOKEN \
               --source $SOURCE_PATH \
               --target /home/runner/work/ui-app/ui-app/temp/ \
               run --suite $SUITE_PATH \
               --total-nodes 1 --node-id 0 \
               --branch ${{ github.ref_name }} --job-name $JOB_NAME \
               --run-profile $RUN_PROFILE_PATH
          
         
