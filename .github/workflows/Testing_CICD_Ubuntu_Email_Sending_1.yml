name: Run DevAssure Tests in Ubuntu - Send Test Result to Email

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']
  workflow_dispatch:

env:
  JOB_NAME: dev_tests
  DEVASSURE_CLI_URL: https://devassures3bucket.s3.amazonaws.com/linux/cli/DevAssure.zip
  SOURCE_PATH: ${{ github.workspace }}/Test_CICD
  TARGET_PATH: ${{ github.workspace }}/temp
  SUITE_PATH: ${{ github.workspace }}/Test_CICD/test-suite/base.suite.tspp
  RUN_PROFILE_PATH: ${{ github.workspace }}/Test_CICD/run-profile/base.profile.tspp
  ENVIRONMENT: UAT_Environment

jobs:
  execute_test:
    runs-on: ubuntu-22.04

    steps:
      # Step 1: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 3: Downgrade npm to fix DevAssure compatibility
      - name: Downgrade npm to v9
        run: |
          npm install -g npm@9
          npm --version
          node --version

      # Step 4: Install pnpm
      - name: Install pnpm
        run: |
          npm install -g pnpm
          pnpm --version

      # Step 5: Install required Linux libraries
      - name: Install DevAssure CLI dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl unzip ffmpeg xvfb \
          libnss3 libatk-bridge2.0-0 libgtk-3-0 libx11-xcb1 libxcomposite1 libxdamage1 libxrandr2 libgbm1 \
          libasound2 fonts-liberation fonts-noto-color-emoji fonts-unifont

      # Step 6: Download and unzip DevAssure CLI
      - name: Download and Unzip DevAssure CLI
        run: |
          echo "Downloading DevAssure CLI..."
          curl -L "${DEVASSURE_CLI_URL}" -o DevAssure.zip
          unzip -o DevAssure.zip
          chmod +x ./DA
          echo "âœ… DevAssure CLI ready."

      # Step 7: Install project dependencies
      - name: Install project dependencies
        working-directory: ${{ env.SOURCE_PATH }}
        run: |
          rm -rf node_modules pnpm-lock.yaml
          pnpm install --no-frozen-lockfile

      # Step 8: Setup DevAssure dependencies (optional)
      - name: Setup DevAssure dependencies
        run: |
          if [ -f ./tpp_setup_browsers ]; then
            chmod +x ./tpp_setup_browsers
            ./tpp_setup_browsers || echo "âš ï¸ Browser setup failed (non-blocking)"
          else
            echo "tpp_setup_browsers not found, skipping."
          fi

      # Step 9: Execute DevAssure Tests (non-blocking)
      - name: Execute DevAssure Tests
        continue-on-error: true
        env:
          JOB_NAME: ${{ env.JOB_NAME }}
          SOURCE_PATH: ${{ env.SOURCE_PATH }}
          TARGET_PATH: ${{ env.TARGET_PATH }}
          SUITE_PATH: ${{ env.SUITE_PATH }}
          RUN_PROFILE_PATH: ${{ env.RUN_PROFILE_PATH }}
          DEVASSURE_AUTH_TOKEN: ${{ secrets.DEVASSURE_AUTH_TOKEN }}
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          echo "ğŸš€ Running DevAssure Tests..."
          mkdir -p "$TARGET_PATH"
          chmod 777 "$TARGET_PATH"

          ./DA --auth-token "$DEVASSURE_AUTH_TOKEN" \
               --source "$SOURCE_PATH" \
               --target "$TARGET_PATH" \
               run --suite "$SUITE_PATH" \
               --total-nodes 1 --node-id 0 \
               --branch main \
               --job-name "$JOB_NAME" \
               --run-profile "$RUN_PROFILE_PATH" || true

          echo "âœ… DevAssure execution complete (exit code ignored)."

      # Step 10: Upload all results
      - name: Upload DevAssure Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: DevAssure_Test_Results
          path: |
            ${{ env.TARGET_PATH }}/.target/**
            ${{ env.TARGET_PATH }}/**

      # Step 11: Extract Test Summary
      - name: Extract Test Summary
        if: always()
        id: extract_summary
        run: |
          SUMMARY_PATH="${{ env.TARGET_PATH }}/.target/Test_GitHub_Runner/html-report/summary.json"
          if [ -f "$SUMMARY_PATH" ]; then
            echo "âœ… Summary file found."
            PASSED=$(jq -r '.passed // 0' "$SUMMARY_PATH")
            FAILED=$(jq -r '.failed // 0' "$SUMMARY_PATH")
            TOTAL=$(jq -r '.totalTests // 0' "$SUMMARY_PATH")
            echo "PASSED=$PASSED" >> $GITHUB_ENV
            echo "FAILED=$FAILED" >> $GITHUB_ENV
            echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          else
            echo "âš ï¸ No summary.json found."
            echo "PASSED=0" >> $GITHUB_ENV
            echo "FAILED=0" >> $GITHUB_ENV
            echo "TOTAL=0" >> $GITHUB_ENV
          fi

      # Step 12: Send Email Notification (with debug)
      - name: Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          debug: true
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ“Š DevAssure Test Run #${{ github.run_number }}"
          from: ${{ secrets.EMAIL_USERNAME }}
          to: mtxqa1@gmail.com
          body: |
            ğŸš€ DevAssure Tests Finished!

            ğŸ“‹ Repository: ${{ github.repository }}
            ğŸ§ª Workflow Run: ${{ github.run_number }}
            âœ… Passed: ${{ env.PASSED }}
            âŒ Failed: ${{ env.FAILED }}
            ğŸ“Š Total: ${{ env.TOTAL }}

            ğŸ“ HTML Report is attached.
          attachments: |
            ${{ env.TARGET_PATH }}/.target/Test_GitHub_Runner/html-report/index.html
