name: DevAssure Test Workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  dev_tests:
    runs-on: ubuntu-latest
    env:
      JOB_NAME: dev_tests
      DEVASSURE_CLI_URL: https://devassures3bucket.s3.amazonaws.com/linux/cli/DevAssure.zip
      SOURCE_PATH: ${{ github.workspace }}/Test_CICD
      TARGET_PATH: ${{ github.workspace }}/temp
      SUITE_PATH: ${{ github.workspace }}/Test_CICD/test-suite/base.suite.tspp
      RUN_PROFILE_PATH: ${{ github.workspace }}/Test_CICD/run-profile/base.profile.tspp
      ENVIRONMENT: UAT_Environment

    steps:

      # -------------------------
      # 1Ô∏è‚É£ Checkout repository
      - name: "01Ô∏è‚É£ Checkout code"
        uses: actions/checkout@v3

      # -------------------------
      # 2Ô∏è‚É£ Setup Node.js
      - name: "02Ô∏è‚É£ Setup Node.js"
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"

      # -------------------------
      # 3Ô∏è‚É£ Install unzip (for DevAssure CLI)
      - name: "03Ô∏è‚É£ Install unzip"
        run: sudo apt-get update && sudo apt-get install -y unzip

      # -------------------------
      # 4Ô∏è‚É£ Download & prepare DevAssure CLI
      - name: "04Ô∏è‚É£ Download DevAssure CLI"
        run: |
          echo "‚¨áÔ∏è Downloading DevAssure CLI..."
          mkdir -p "$TARGET_PATH/DA"
          curl -L "$DEVASSURE_CLI_URL" -o "$TARGET_PATH/DA/DevAssure.zip"
          unzip "$TARGET_PATH/DA/DevAssure.zip" -d "$TARGET_PATH/DA"
          chmod +x "$TARGET_PATH/DA/DA"
          export PATH="$TARGET_PATH/DA:$PATH"

      # -------------------------
      # 5Ô∏è‚É£ Run DevAssure Tests
      - name: "05Ô∏è‚É£ Execute DevAssure Tests"
        shell: bash
        continue-on-error: true
        run: |
          echo "üöÄ Running DevAssure Tests..."
          mkdir -p "$TARGET_PATH"
          chmod 777 "$TARGET_PATH"

          ./DA run \
            "$SUITE_PATH" \
            "$RUN_PROFILE_PATH" \
            --target "$TARGET_PATH" \
            --environment "$ENVIRONMENT" \
            --total-nodes 1 \
            --node-id 0 \
            --debug || true

          echo "Debug: Listing target folder contents:"
          ls -R "$TARGET_PATH" || true

      # -------------------------
      # 6Ô∏è‚É£ Upload artifacts
      - name: "06Ô∏è‚É£ Upload DevAssure Results"
        uses: actions/upload-artifact@v4
        with:
          name: DevAssure_Test_Results
          path: ${{ env.TARGET_PATH }}

      # -------------------------
      # 7Ô∏è‚É£ Parse summary.json
      - name: "07Ô∏è‚É£ Parse summary.json"
        shell: bash
        run: |
          SUMMARY_JSON=$(find "$TARGET_PATH" -type f -name "summary.json" | head -n 1)

          if [ -z "$SUMMARY_JSON" ]; then
            echo "‚ùå Summary not found. Setting all values to 0."
            echo "PASSED=0" >> $GITHUB_ENV
            echo "FAILED=0" >> $GITHUB_ENV
            echo "TOTAL=0" >> $GITHUB_ENV
            exit 0
          fi

          echo "‚úÖ Found summary.json at: $SUMMARY_JSON"
          echo "---- Contents ----"
          cat "$SUMMARY_JSON"
          echo "------------------"

          PASSED=$(jq '.passed // 0' "$SUMMARY_JSON")
          FAILED=$(jq '.failed // 0' "$SUMMARY_JSON")
          TOTAL=$(jq '.total // 0' "$SUMMARY_JSON")

          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV

      # -------------------------
      # 8Ô∏è‚É£ Send email (optional)
      - name: "08Ô∏è‚É£ Send email with results"
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.example.com
          server_port: 587
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "DevAssure Test Results"
          body: |
            ‚úÖ PASSED: ${{ env.PASSED }}
            ‚ùå FAILED: ${{ env.FAILED }}
            üìä TOTAL: ${{ env.TOTAL }}
          to: team@example.com
          from: ci@example.com
