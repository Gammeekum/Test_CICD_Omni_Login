name: Run DevAssure Tests in Ubuntu

on:
  push:
    branches: ['*']
    tags: ['*']
  pull_request:
    branches: ['*']
  workflow_dispatch:

env:
  JOB_NAME: dev_tests
  DEVASSURE_CLI_URL: https://devassures3bucket.s3.amazonaws.com/linux/cli/DevAssure.zip
  SOURCE_PATH: ${{ github.workspace }}/Test_CICD
  TARGET_PATH: ${{ github.workspace }}/temp
  SUITE_PATH: ${{ github.workspace }}/Test_CICD/test-suite/base.suite.tspp
  RUN_PROFILE_PATH: ${{ github.workspace }}/Test_CICD/run-profile/base.profile.tspp
  ENVIRONMENT: UAT_Environment  # âœ… fixed typo

jobs:
  execute_test:
    runs-on: ubuntu-22.04

    steps:

      # ----------------------------------------
      # 1ï¸âƒ£ Checkout Repository
      - name: 1ï¸âƒ£ Checkout Repository
        uses: actions/checkout@v4
      # ----------------------------------------

      # 2ï¸âƒ£ Setup Node.js (downgrade to v18 for DevAssure CLI compatibility)
      - name: 2ï¸âƒ£ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: 3ï¸âƒ£ Downgrade npm to v9
        run: |
          echo "Downgrading npm to v9..."
          npm install -g npm@9
          npm --version
          node --version

      # 4ï¸âƒ£ Install pnpm
      - name: 4ï¸âƒ£ Install pnpm
        run: |
          npm install -g pnpm
          pnpm --version

      # 5ï¸âƒ£ Install DevAssure CLI dependencies
      - name: 5ï¸âƒ£ Install DevAssure CLI dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libasound2 libatk-bridge2.0-0 libatk1.0-0 libatspi2.0-0 libcairo2 libcups2 \
            libdbus-1-3 libdrm2 libgbm1 libglib2.0-0 libnspr4 libnss3 libpango-1.0-0 \
            libwayland-client0 libx11-6 libxcb1 libxcomposite1 libxdamage1 libxext6 \
            libxfixes3 libxkbcommon0 libxrandr2 ffmpeg libcairo-gobject2 libdbus-glib-1-2 \
            libfontconfig1 libfreetype6 libgdk-pixbuf-2.0-0 libgtk-3-0 libpangocairo-1.0-0 \
            libx11-xcb1 libxcb-shm0 libxcursor1 libxi6 libxrender1 libxtst6 libsoup-3.0-0 \
            libenchant-2-2 gstreamer1.0-libav gstreamer1.0-plugins-bad gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good libicu70 libegl1 libepoxy0 libevdev2 libffi7 libgles2 libglx0 \
            libgstreamer-gl1.0-0 libgstreamer-plugins-base1.0-0 libgstreamer1.0-0 libgtk-4-1 \
            libgudev-1.0-0 libharfbuzz-icu0 libharfbuzz0b libhyphen0 libjpeg-turbo8 liblcms2-2 \
            libmanette-0.2-0 libnotify4 libopengl0 libopenjp2-7 libopus0 libpng16-16 libproxy1v5 \
            libsecret-1-0 libwayland-egl1 libwayland-server0 libwebpdemux2 libwoff1 libxml2 \
            libxslt1.1 libx264-163 libatomic1 libevent-2.1-7 libavif13 xvfb fonts-noto-color-emoji \
            fonts-unifont xfonts-cyrillic xfonts-scalable fonts-liberation fonts-ipafont-gothic \
            fonts-wqy-zenhei fonts-tlwg-loma-otf fonts-freefont-ttf

      # 6ï¸âƒ£ Download and unzip DevAssure CLI
      - name: 6ï¸âƒ£ Download and Unzip DevAssure CLI
        shell: bash
        run: |
          curl -L "${DEVASSURE_CLI_URL}" -o DevAssure.zip
          unzip -o DevAssure.zip
          chmod +x ./DA
          echo "âœ… DevAssure CLI ready."

      # 7ï¸âƒ£ Install project dependencies
      - name: 7ï¸âƒ£ Install project dependencies
        working-directory: ${{ env.SOURCE_PATH }}
        run: |
          rm -rf node_modules pnpm-lock.yaml
          pnpm install --no-frozen-lockfile

      # 8ï¸âƒ£ Setup DevAssure browsers (optional)
      - name: 8ï¸âƒ£ Setup DevAssure browsers
        shell: bash
        run: |
          if [ -f ./tpp_setup_browsers ]; then
            chmod +x ./tpp_setup_browsers
            ./tpp_setup_browsers || echo "âš ï¸ tpp_setup_browsers failed (non-blocking)"
          fi

      # 9ï¸âƒ£ Execute DevAssure Tests
      - name: 9ï¸âƒ£ Execute DevAssure Tests
        shell: bash
        continue-on-error: true
        env:
          DEVASSURE_AUTH_TOKEN: ${{ secrets.DEVASSURE_AUTH_TOKEN }}
        run: |
          echo "ðŸš€ Running DevAssure Tests..."
          mkdir -p "$TARGET_PATH"
          chmod 777 "$TARGET_PATH"

          ./DA --auth-token "$DEVASSURE_AUTH_TOKEN" \
               --source "$SOURCE_PATH" \
               --target "$TARGET_PATH" \
               run --suite "$SUITE_PATH" \
               --total-nodes 1 --node-id 0 \
               --branch main \
               --job-name "$JOB_NAME" \
               --run-profile "$RUN_PROFILE_PATH" || true

          echo "Debug: Listing contents of target folder:"
          ls -R "$TARGET_PATH"

      # 10ï¸âƒ£ Wait for .target folder
      - name: 10ï¸âƒ£ Wait for DevAssure results (.target)
        run: |
          for i in {1..20}; do
            if [ -d "${TARGET_PATH}/.target" ]; then
              echo "âœ… .target folder detected!"
              ls -R "${TARGET_PATH}/.target"
              break
            fi
            sleep 3
          done

      # 11ï¸âƒ£ Detect .target folder
      - name: 11ï¸âƒ£ Detect .target result folder
        run: |
          TARGET1="${TARGET_PATH}/.target"
          TARGET2="${SOURCE_PATH}/.target"

          if [ -d "$TARGET1" ]; then
            echo "FOUND_TARGET=$TARGET1" >> $GITHUB_ENV
          elif [ -d "$TARGET2" ]; then
            echo "FOUND_TARGET=$TARGET2" >> $GITHUB_ENV
          else
            echo "FOUND_TARGET=" >> $GITHUB_ENV
          fi

      # 12ï¸âƒ£ Upload DevAssure Test Results
      - name: 12ï¸âƒ£ Upload DevAssure Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: DevAssure_Test_Results
          path: ${{ env.FOUND_TARGET }}/Test_GitHub_Runner/html-report
          if-no-files-found: warn

      # 13ï¸âƒ£ Print and extract summary.json
      - name: 13ï¸âƒ£ Print summary.json and extract results
        if: always()
        run: |
          SUMMARY_JSON=$(find "${TARGET_PATH}" "${SOURCE_PATH}" -type f -name "summary.json" | head -n 1)
          if [ -z "$SUMMARY_JSON" ]; then
            echo "âŒ Summary not found. Setting all values to 0."
            echo "PASSED=0" >> $GITHUB_ENV
            echo "FAILED=0" >> $GITHUB_ENV
            echo "TOTAL=0" >> $GITHUB_ENV
            exit 0
          fi

          echo "âœ… Found summary.json at: $SUMMARY_JSON"
          echo "---- Contents ----"
          cat "$SUMMARY_JSON"
          echo "------------------"

          PASSED=$(jq '.passed // 0' "$SUMMARY_JSON")
          FAILED=$(jq '.failed // 0' "$SUMMARY_JSON")
          TOTAL=$(jq '.total // 0' "$SUMMARY_JSON")

          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
