name: Run DevAssure Tests in Ubuntu

on:
  push:
    branches: ['*']
    tags: ['*']
  pull_request:
    branches: ['*']
  workflow_dispatch:

env:
  JOB_NAME: dev_tests
  DEVASSURE_CLI_URL: https://devassures3bucket.s3.amazonaws.com/linux/cli/DevAssure.zip
  SOURCE_PATH: ${{ github.workspace }}/Test_CICD
  TARGET_PATH: ${{ github.workspace }}/temp
  SUITE_PATH: ${{ github.workspace }}/Test_CICD/test-suite/base.suite.tspp
  RUN_PROFILE_PATH: ${{ github.workspace }}/Test_CICD/run-profile/base.profile.tspp
  ENVIRONMENT: UAT_Environment

jobs:
  execute_test:
    runs-on: ubuntu-22.04

    steps:
      - name: 1ï¸âƒ£ Checkout Repository
        uses: actions/checkout@v4

      - name: 2ï¸âƒ£ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: 3ï¸âƒ£ Downgrade npm to v9
        run: |
          npm install -g npm@9
          npm --version

      - name: 4ï¸âƒ£ Install pnpm
        run: |
          npm install -g pnpm
          pnpm --version

      - name: 5ï¸âƒ£ Install browser dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk-3-0 libx11-xcb1 libxcomposite1 libxdamage1 \
            libxrandr2 libasound2 libatk1.0-0 libpangocairo-1.0-0 ffmpeg fonts-noto-color-emoji \
            libnss3 libgconf-2-4 wget curl unzip

      - name: 6ï¸âƒ£ Download DevAssure CLI
        run: |
          curl -L "${DEVASSURE_CLI_URL}" -o DevAssure.zip
          unzip -o DevAssure.zip
          chmod +x ./DA

      - name: 7ï¸âƒ£ Install project node modules
        working-directory: ${{ env.SOURCE_PATH }}
        run: |
          rm -rf node_modules pnpm-lock.yaml
          pnpm install --no-frozen-lockfile

      - name: 8ï¸âƒ£ Setup DevAssure browsers
        run: |
          if [ -f ./tpp_setup_browsers ]; then
            chmod +x ./tpp_setup_browsers
            ./tpp_setup_browsers || echo "âš ï¸ Browser setup failed (non-blocking)"
          fi

      - name: 9ï¸âƒ£ Run DevAssure Tests (headful)
        continue-on-error: true
        env:
          DEVASSURE_AUTH_TOKEN: ${{ secrets.DEVASSURE_AUTH_TOKEN }}
        run: |
          echo "ğŸš€ Running DevAssure Tests..."
          mkdir -p "$TARGET_PATH"

          # Run inside Xvfb so GUI browser works
          Xvfb :99 -screen 0 1920x1080x24 &
          export DISPLAY=:99

          ./DA --auth-token "$DEVASSURE_AUTH_TOKEN" \
             --source "$SOURCE_PATH" \
             --target "$TARGET_PATH" \
             run --suite "$SUITE_PATH" \
             --total-nodes 1 --node-id 0 \
             --branch main \
             --job-name "$JOB_NAME" \
             --run-profile "$RUN_PROFILE_PATH" \
             --headless false \
             --screenshot-after-step true || true

          echo "Listing target directory:"
          ls -R "$TARGET_PATH"

      - name: ğŸ”Ÿ Wait for .target folder
        run: |
          for i in {1..20}; do
            if [ -d "${TARGET_PATH}/.target" ]; then
              echo "âœ… .target found."
              ls -R "${TARGET_PATH}/.target"
              break
            fi
            echo "Waiting ($i/20)..."
            sleep 3
          done

      - name: 1ï¸âƒ£1ï¸âƒ£ Upload DevAssure Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: DevAssure_Test_Results
          path: ${{ env.TARGET_PATH }}/.target/Test_GitHub_Runner/**
          if-no-files-found: warn

      - name: 1ï¸âƒ£2ï¸âƒ£ Extract Test Summary
        if: always()
        run: |
          SUMMARY_JSON=$(find "${TARGET_PATH}" -type f -name "summary.json" | head -n 1)
          if [ -z "$SUMMARY_JSON" ]; then
            echo "PASSED=0" >> $GITHUB_ENV
            echo "FAILED=0" >> $GITHUB_ENV
            echo "TOTAL=0" >> $GITHUB_ENV
            exit 0
          fi
          PASSED=$(jq '.passed' "$SUMMARY_JSON")
          FAILED=$(jq '.failed' "$SUMMARY_JSON")
          TOTAL=$(jq '.totalTests' "$SUMMARY_JSON")
          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV

      - name: 1ï¸âƒ£3ï¸âƒ£ Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          from: ${{ secrets.EMAIL_USERNAME }}
          to: gamtaa@gmail.com, mtxqa1@gmail.com
          subject: "ğŸ“Š DevAssure Test Run #${{ github.run_number }}"
          body: |
            ğŸš€ DevAssure Tests Finished!

            ğŸ“‹ Repository: ${{ github.repository }}
            ğŸ§ª Workflow Run: ${{ github.run_number }}

            âœ… Passed: ${{ env.PASSED }}
            âŒ Failed: ${{ env.FAILED }}
            ğŸ“Š Total: ${{ env.TOTAL }}

            ğŸ“ HTML report is attached if available.
          attachments: |
            ${{ env.TARGET_PATH }}/.target/**/html-report/index.html
